name: PR Handler (apply fixes from AI feedback) - GPT-5.2 xhigh

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

concurrency:
  group: pr-fix-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  fix:
    if: |
      github.event.issue.pull_request != null &&
      contains(github.event.comment.body, '#AI_LOOP_FEEDBACK')
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Resolve PR context
        id: ctx
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.issue.number;
            const { data: pr } = await github.rest.pulls.get({ owner, repo, pull_number: prNumber });
            core.setOutput('pr_number', String(prNumber));
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('head_sha', pr.head.sha);
            core.setOutput('head_repo', pr.head.repo.full_name);

      - name: Checkout PR head (branch)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}
          repository: ${{ steps.ctx.outputs.head_repo }}
          ref: ${{ steps.ctx.outputs.head_ref }}

      - name: Configure Git
        run: |
          git config user.name "opencode[bot]"
          git config user.email "opencode[bot]@users.noreply.github.com"

      - name: Run OpenCode (apply fixes)
        uses: anomalyco/opencode/github@latest
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          GITHUB_TOKEN: ${{ secrets.PAT }}
        with:
          model: openai/gpt-5.2
          use_github_token: true
          prompt: |
            You are the PR handler. You MUST implement the changes requested by the latest #AI_LOOP_FEEDBACK comment.

            HARD RULES:
            - Only fix what the feedback asks.
            - Keep changes minimal.

            Required verification:
            - bun install --frozen-lockfile
            - bun run typecheck
            - bun run test:ci

            Commit/push:
            - Commit message must start with: "autofix:".
            - Push to the PR branch.

      - name: Trigger next review (/opencode)
        if: ${{ always() }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = Number('${{ steps.ctx.outputs.pr_number }}');
            await github.rest.issues.createComment({ owner, repo, issue_number: prNumber, body: '/opencode' });
