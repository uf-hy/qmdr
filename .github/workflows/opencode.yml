# OpenCode CLI ‚Äî Issue Ëß¶ÂèëËá™Âä®Êîπ‰ª£Á†Å
# Ê®°ÂûãÔºögpt-5.2 | ÊÄùËÄÉÔºöhigh
name: OpenCode Agent

on:
  issues:
    types: [opened, labeled]
  pull_request:
    types: [closed]

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write

jobs:
  opencode:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    concurrency:
      group: opencode-issue-${{ github.event.issue.number }}
      cancel-in-progress: true
    # ÂΩì issue Ë¢´ÊâìÂºÄÔºåÊàñËÄÖË¢´Ê†áËÆ∞‰∏∫ "auto-work" Êó∂Ëß¶Âèë
    if: |
      (github.event_name == 'issues' && github.event.action == 'opened') ||
      (github.event_name == 'issues' && github.event.label.name == 'auto-work')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify Telegram (issue started)
        if: github.event_name == 'issues'
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          ISSUE_NUM: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          if [ -z "$TG_BOT_TOKEN" ] || [ -z "$TG_CHAT_ID" ]; then
            echo "TG secrets missing, skip notification"
            exit 0
          fi
          ISSUE_URL="${{ github.server_url }}/${{ github.repository }}/issues/${ISSUE_NUM}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          TEXT=$(cat <<EOF
          üöÄ [IssueÂºÄÂßãÂ§ÑÁêÜ] #${ISSUE_NUM} ${ISSUE_TITLE}
          ${ISSUE_URL}
          Run: ${RUN_URL}
          EOF
          )
          curl -fsS -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage" \
            -d chat_id="$TG_CHAT_ID" \
            --data-urlencode text="$TEXT" \
            -d disable_web_page_preview=true >/dev/null || true

      - name: Configure Git
        run: |
          git config user.name "opencode[bot]"
          git config user.email "opencode[bot]@users.noreply.github.com"

      - name: Install OpenCode CLI
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Create OpenCode config
        env:
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
        run: |
          mkdir -p ~/.config/opencode
          python3 - <<'PY'
          import os, json
          from pathlib import Path

          cfg = {
            "$schema": "https://opencode.ai/config.json",
            # ÂÖ≥ÈîÆÔºöOpenCode ÁöÑ --model ÈúÄË¶Å provider/model Ê†ºÂºè
            "model": "openai/gpt-5.2",
            # ÂÖ≥ÈîÆÔºöÁî® config Ë¶ÜÁõñ OpenAI baseURL ÊåáÂêë‰Ω†ÁöÑ‰∏≠ËΩ¨Á´ô
            "provider": {
              "openai": {
                "options": {
                  "baseURL": os.environ["OPENAI_BASE_URL"].rstrip("/")
                }
              }
            }
          }

          conf_dir = Path.home() / ".config" / "opencode"
          conf_dir.mkdir(parents=True, exist_ok=True)
          (conf_dir / "opencode.json").write_text(json.dumps(cfg, ensure_ascii=False, indent=2))
          (conf_dir / "opencode.jsonc").write_text(json.dumps(cfg, ensure_ascii=False, indent=2))
          PY

      - name: Collect PR reviewer feedback (latest)
        id: feedback
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNum = context.payload.issue.number;
            const marker = '<!-- AI_PR_REVIEW_FEEDBACK -->';
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNum,
              per_page: 100,
            });
            const rounds = comments.filter(c => (c.body || '').includes(marker)).length;
            const latest = [...comments].reverse().find(c => (c.body || '').includes(marker));
            core.setOutput('rounds', String(rounds));
            core.setOutput('text', latest ? latest.body : '');

      - name: Run OpenCode
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REVIEW_FEEDBACK: ${{ steps.feedback.outputs.text }}
          REVIEW_ROUNDS: ${{ steps.feedback.outputs.rounds }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          python3 - <<'PY'
          import os
          from pathlib import Path

          title = os.environ.get('ISSUE_TITLE','')
          body = os.environ.get('ISSUE_BODY','')
          num = os.environ.get('ISSUE_NUMBER','')
          feedback = os.environ.get('REVIEW_FEEDBACK','').strip()
          rounds = os.environ.get('REVIEW_ROUNDS','0')

          parts = []
          parts.append('Ê†πÊçÆ‰ª•‰∏ãÈúÄÊ±Ç‰øÆÊîπ‰ª£Á†ÅÔºö')
          parts.append(f'Ê†áÈ¢òÔºö{title}')
          parts.append('ÂÜÖÂÆπÔºö')
          parts.append(body)
          parts.append('')
          parts.append('RULES:')
          parts.append('1. ONLY modify files listed in the issue\'s \'Scope\' section (if any)')
          parts.append('2. Focus on: correctness, performance, robustness, clean code')
          parts.append('3. Run \'bun test\' after changes to verify nothing breaks')
          parts.append('4. Keep changes minimal and focused on the issue description')
          parts.append(f'5. Commit with message: \'fix: <short description> (closes #{num})\'')

          if feedback:
            parts.append('')
            parts.append('---')
            parts.append(f'PR Reviewer ÂèçÈ¶àÔºàÁ¥ØËÆ° {rounds} ËΩÆÔºõÂ¶ÇÊúâ Blocking ÂøÖÈ°ª‰ºòÂÖàËß£ÂÜ≥ÔºâÔºö')
            parts.append(feedback)

          prompt='\n'.join(parts)
          Path('/tmp/opencode_prompt.txt').write_text(prompt, encoding='utf-8')
          PY

          # Áî®ÈôÑ‰ª∂ÊñπÂºè‰º†ÂÖ•Èïø promptÔºåÈÅøÂÖç shell ÂºïÂè∑/Êç¢Ë°åË¢´ÂêÉÊéâ
          opencode run \
            --model openai/gpt-5.2 \
            --variant xhigh \
            --file /tmp/opencode_prompt.txt \
            -- \
            "ÊåâÈôÑ‰ª∂ opencode_prompt.txt ÁöÑË¶ÅÊ±Ç‰øÆÊîπ‰ª£Á†Å„ÄÇ"

      - name: Create PR
        id: pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: opencode/issue-${{ github.event.issue.number }}
          title: "üõ†Ô∏è OpenCode: ${{ github.event.issue.title }}"
          body: |
            Áî± OpenCode CLI (gpt-5.2, thinking: high) Ëá™Âä®ÁîüÊàê
            ÂØπÂ∫î Issue #${{ github.event.issue.number }}
            
            Closes #${{ github.event.issue.number }}
          commit-message: "feat: opencode auto-fix #${{ github.event.issue.number }}"
          labels: agent-opencode,auto-pr

      - name: Comment on issue
        if: steps.pr.outputs.pull-request-number
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNum = ${{ github.event.issue.number }};
            const prNum = ${{ steps.pr.outputs.pull-request-number }};
            const msg = `‚úÖ OpenCode Â∑≤ÂàõÂª∫ PR #${prNum}\n\nËØ∑Êü•ÁúãÂπ∂ÂêàÂπ∂„ÄÇ`;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNum,
              per_page: 100,
            });

            const already = comments.some(c => (c.body || '').includes(`PR #${prNum}`));
            if (already) {
              core.info('Comment already exists, skip');
              return;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNum,
              body: msg,
            });

      - name: Notify Telegram (PR created)
        if: steps.pr.outputs.pull-request-number
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          ISSUE_NUM: ${{ github.event.issue.number }}
          PR_NUM: ${{ steps.pr.outputs.pull-request-number }}
        run: |
          if [ -z "$TG_BOT_TOKEN" ] || [ -z "$TG_CHAT_ID" ]; then
            echo "TG secrets missing, skip notification"
            exit 0
          fi
          ISSUE_URL="${{ github.server_url }}/${{ github.repository }}/issues/${ISSUE_NUM}"
          PR_URL="${{ github.server_url }}/${{ github.repository }}/pull/${PR_NUM}"
          TEXT=$(cat <<EOF
          üß© [PRÂ∑≤ÂàõÂª∫] #${PR_NUM} (from Issue #${ISSUE_NUM})
          ${PR_URL}
          Issue: ${ISSUE_URL}
          EOF
          )
          curl -fsS -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage" \
            -d chat_id="$TG_CHAT_ID" \
            --data-urlencode text="$TEXT" \
            -d disable_web_page_preview=true >/dev/null || true

      - name: Notify Telegram (issue run failed)
        if: failure()
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          ISSUE_NUM: ${{ github.event.issue.number }}
        run: |
          if [ -z "$TG_BOT_TOKEN" ] || [ -z "$TG_CHAT_ID" ]; then
            exit 0
          fi
          ISSUE_URL="${{ github.server_url }}/${{ github.repository }}/issues/${ISSUE_NUM}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          TEXT=$(cat <<EOF
          ‚ùå [IssueÂ§ÑÁêÜÂ§±Ë¥•] #${ISSUE_NUM}
          ${ISSUE_URL}
          Run: ${RUN_URL}
          EOF
          )
          curl -fsS -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage" \
            -d chat_id="$TG_CHAT_ID" \
            --data-urlencode text="$TEXT" \
            -d disable_web_page_preview=true >/dev/null || true

  # ÈìæÂºèËß¶ÂèëÔºöÂΩì PR ÂêàÂπ∂ÂêéÔºåËß¶Âèë‰∏ã‰∏Ä‰∏™ issue
  chain-next:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' &&
      github.event.pull_request.merged == true &&
      contains(github.event.pull_request.labels.*.name, 'auto-pr')
    steps:
      - uses: actions/checkout@v4

      - name: Find and trigger next issue
        id: chain
        env:
          # Áî® PAT Ê∑ªÂä† labelÔºåÁ°Æ‰øùËÉΩËß¶Âèë issues:labeledÔºàGITHUB_TOKEN ‰ºöË¢´ GitHub Èò≤ÈÄíÂΩíÂêûÊéâÔºâ
          GH_TOKEN: ${{ secrets.PAT }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          CLOSED_ISSUE=$(echo "$PR_BODY" | grep -oP 'Closes #\K\d+' | head -1)
          
          if [ -z "$CLOSED_ISSUE" ]; then
            echo "No linked issue found, skipping chain"
            echo "closed_issue=" >> $GITHUB_OUTPUT
            echo "next_issues=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Merged PR closed issue #$CLOSED_ISSUE"
          
          # Find next issue in the chain
          NEXT_ISSUES=$(gh issue list --state open --label "auto-chain" --json number,body -q ".[] | select(.body | test(\"depends on #$CLOSED_ISSUE\"; \"i\")) | .number" | tr '\n' ' ' | xargs)
          
          for ISSUE_NUM in $NEXT_ISSUES; do
            echo "Triggering next issue: #$ISSUE_NUM"
            gh issue edit "$ISSUE_NUM" --add-label "auto-work"
          done
          
          if [ -z "$NEXT_ISSUES" ]; then
            echo "No chained issues found. Pipeline complete!"
          fi

          echo "closed_issue=$CLOSED_ISSUE" >> $GITHUB_OUTPUT
          echo "next_issues=$NEXT_ISSUES" >> $GITHUB_OUTPUT

      - name: Notify Telegram (merged / chain status, detailed)
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          PR_NUM: ${{ github.event.pull_request.number }}
          CLOSED_ISSUE: ${{ steps.chain.outputs.closed_issue }}
          NEXT_ISSUES: ${{ steps.chain.outputs.next_issues }}
        run: |
          if [ -z "$TG_BOT_TOKEN" ] || [ -z "$TG_CHAT_ID" ]; then
            exit 0
          fi
          PR_URL="${{ github.server_url }}/${{ github.repository }}/pull/${PR_NUM}"
          if [ -n "$NEXT_ISSUES" ]; then
            TEXT=$(cat <<EOF
            ‚úÖ [Â∑≤ÂêàÂπ∂-ÈìæË∑ØÁªßÁª≠]
            PR #${PR_NUM} Â∑≤ÂêàÂπ∂
            ${PR_URL}
            ÂÖ≥Èó≠ Issue: #${CLOSED_ISSUE}
            Â∑≤Ëß¶Âèë‰∏ã‰∏Ä‰∏™: ${NEXT_ISSUES}
            EOF
            )
          else
            TEXT=$(cat <<EOF
            ‚úÖ [Â∑≤ÂêàÂπ∂-ÈìæË∑ØÂÆåÊàê]
            PR #${PR_NUM} Â∑≤ÂêàÂπ∂
            ${PR_URL}
            ÂÖ≥Èó≠ Issue: #${CLOSED_ISSUE}
            Ê≤°Êúâ‰∏ã‰∏Ä‰∏™ auto-chain ‰ªªÂä°„ÄÇ
            EOF
            )
          fi
          curl -fsS -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage" \
            -d chat_id="$TG_CHAT_ID" \
            --data-urlencode text="$TEXT" \
            -d disable_web_page_preview=true >/dev/null || true
