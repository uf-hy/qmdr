# OpenCode CLI â€” Issue è§¦å‘è‡ªåŠ¨æ”¹ä»£ç 
# æ¨¡å‹ï¼šgpt-5.2 | æ€è€ƒï¼šhigh
name: OpenCode Agent

on:
  issues:
    types: [opened, labeled]
  pull_request:
    types: [closed]

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write

jobs:
  opencode:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    concurrency:
      group: opencode-issue-${{ github.event.issue.number }}
      cancel-in-progress: true
    # å½“ issue è¢«æ‰“å¼€ï¼Œæˆ–è€…è¢«æ ‡è®°ä¸º "auto-work" æ—¶è§¦å‘
    if: |
      (github.event_name == 'issues' && github.event.action == 'opened') ||
      (github.event_name == 'issues' && github.event.label.name == 'auto-work')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "opencode[bot]"
          git config user.email "opencode[bot]@users.noreply.github.com"

      - name: Install OpenCode CLI
        run: |
          curl -fsSL https://opencode.ai/install | bash
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Create OpenCode config
        env:
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
        run: |
          mkdir -p ~/.config/opencode
          python3 - <<'PY'
          import os, json
          from pathlib import Path

          cfg = {
            "$schema": "https://opencode.ai/config.json",
            # å…³é”®ï¼šOpenCode çš„ --model éœ€è¦ provider/model æ ¼å¼
            "model": "openai/gpt-5.2",
            # å…³é”®ï¼šç”¨ config è¦†ç›– OpenAI baseURL æŒ‡å‘ä½ çš„ä¸­è½¬ç«™
            "provider": {
              "openai": {
                "options": {
                  "baseURL": os.environ["OPENAI_BASE_URL"].rstrip("/")
                }
              }
            }
          }

          conf_dir = Path.home() / ".config" / "opencode"
          conf_dir.mkdir(parents=True, exist_ok=True)
          (conf_dir / "opencode.json").write_text(json.dumps(cfg, ensure_ascii=False, indent=2))
          (conf_dir / "opencode.jsonc").write_text(json.dumps(cfg, ensure_ascii=False, indent=2))
          PY

      - name: Collect PR reviewer feedback (latest)
        id: feedback
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNum = context.payload.issue.number;
            const marker = '<!-- AI_PR_REVIEW_FEEDBACK -->';
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNum,
              per_page: 100,
            });
            const rounds = comments.filter(c => (c.body || '').includes(marker)).length;
            const latest = [...comments].reverse().find(c => (c.body || '').includes(marker));
            core.setOutput('rounds', String(rounds));
            core.setOutput('text', latest ? latest.body : '');

      - name: Run OpenCode
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REVIEW_FEEDBACK: ${{ steps.feedback.outputs.text }}
          REVIEW_ROUNDS: ${{ steps.feedback.outputs.rounds }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"

          python3 - <<'PY'
          import os
          from pathlib import Path

          title = os.environ.get('ISSUE_TITLE','')
          body = os.environ.get('ISSUE_BODY','')
          num = os.environ.get('ISSUE_NUMBER','')
          feedback = os.environ.get('REVIEW_FEEDBACK','').strip()
          rounds = os.environ.get('REVIEW_ROUNDS','0')

          parts = []
          parts.append('æ ¹æ®ä»¥ä¸‹éœ€æ±‚ä¿®æ”¹ä»£ç ï¼š')
          parts.append(f'æ ‡é¢˜ï¼š{title}')
          parts.append('å†…å®¹ï¼š')
          parts.append(body)
          parts.append('')
          parts.append('RULES:')
          parts.append('1. ONLY modify files listed in the issue\'s \'Scope\' section (if any)')
          parts.append('2. Focus on: correctness, performance, robustness, clean code')
          parts.append('3. Run \'bun test\' after changes to verify nothing breaks')
          parts.append('4. Keep changes minimal and focused on the issue description')
          parts.append(f'5. Commit with message: \'fix: <short description> (closes #{num})\'')

          if feedback:
            parts.append('')
            parts.append('---')
            parts.append(f'PR Reviewer åé¦ˆï¼ˆç´¯è®¡ {rounds} è½®ï¼›å¦‚æœ‰ Blocking å¿…é¡»ä¼˜å…ˆè§£å†³ï¼‰ï¼š')
            parts.append(feedback)

          prompt='\n'.join(parts)
          Path('/tmp/opencode_prompt.txt').write_text(prompt, encoding='utf-8')
          PY

          # ç”¨é™„ä»¶æ–¹å¼ä¼ å…¥é•¿ promptï¼Œé¿å… shell å¼•å·/æ¢è¡Œè¢«åƒæ‰
          opencode run \
            --model openai/gpt-5.2 \
            --variant xhigh \
            --file /tmp/opencode_prompt.txt \
            -- \
            "æŒ‰é™„ä»¶ opencode_prompt.txt çš„è¦æ±‚ä¿®æ”¹ä»£ç ã€‚"

      - name: Create PR
        id: pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: opencode/issue-${{ github.event.issue.number }}
          title: "ğŸ› ï¸ OpenCode: ${{ github.event.issue.title }}"
          body: |
            ç”± OpenCode CLI (gpt-5.2, thinking: high) è‡ªåŠ¨ç”Ÿæˆ
            å¯¹åº” Issue #${{ github.event.issue.number }}
            
            Closes #${{ github.event.issue.number }}
          commit-message: "feat: opencode auto-fix #${{ github.event.issue.number }}"
          labels: agent-opencode,auto-pr

      - name: Comment on issue
        if: steps.pr.outputs.pull-request-number
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNum = ${{ github.event.issue.number }};
            const prNum = ${{ steps.pr.outputs.pull-request-number }};
            const msg = `âœ… OpenCode å·²åˆ›å»º PR #${prNum}\n\nè¯·æŸ¥çœ‹å¹¶åˆå¹¶ã€‚`;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNum,
              per_page: 100,
            });

            const already = comments.some(c => (c.body || '').includes(`PR #${prNum}`));
            if (already) {
              core.info('Comment already exists, skip');
              return;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNum,
              body: msg,
            });

  # é“¾å¼è§¦å‘ï¼šå½“ PR åˆå¹¶åï¼Œè§¦å‘ä¸‹ä¸€ä¸ª issue
  chain-next:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' &&
      github.event.pull_request.merged == true &&
      contains(github.event.pull_request.labels.*.name, 'auto-pr')
    steps:
      - uses: actions/checkout@v4

      - name: Find and trigger next issue
        env:
          # ç”¨ PAT æ·»åŠ  labelï¼Œç¡®ä¿èƒ½è§¦å‘ issues:labeledï¼ˆGITHUB_TOKEN ä¼šè¢« GitHub é˜²é€’å½’åæ‰ï¼‰
          GH_TOKEN: ${{ secrets.PAT }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          CLOSED_ISSUE=$(echo "$PR_BODY" | grep -oP 'Closes #\K\d+' | head -1)
          
          if [ -z "$CLOSED_ISSUE" ]; then
            echo "No linked issue found, skipping chain"
            exit 0
          fi
          
          echo "Merged PR closed issue #$CLOSED_ISSUE"
          
          # Find next issue in the chain
          NEXT_ISSUES=$(gh issue list --state open --label "auto-chain" --json number,body -q ".[] | select(.body | test(\"depends on #$CLOSED_ISSUE\"; \"i\")) | .number")
          
          for ISSUE_NUM in $NEXT_ISSUES; do
            echo "Triggering next issue: #$ISSUE_NUM"
            gh issue edit "$ISSUE_NUM" --add-label "auto-work"
          done
          
          if [ -z "$NEXT_ISSUES" ]; then
            echo "No chained issues found. Pipeline complete!"
          fi
