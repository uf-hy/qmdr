# PR Reviewer ‚Äî Codex ÂÆ°Êü•ÔºõÊúâÈóÆÈ¢òÂõû‰º†Âà∞ Issue Ëß¶Âèë‰∏ã‰∏ÄËΩÆ‰øÆÂ§çÔºàÊúÄÂ§ö 5 ËΩÆÔºâ
name: PR Reviewer (Codex)

on:
  pull_request_target:
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: pr-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  review:
    runs-on: ubuntu-latest
    # Âè™ÂÆ°Êü•Êú¨‰ªìÂ∫ìÂÜÖÂàÜÊîØ + ‰∏îÂ∏¶ auto-pr Ê†áÁ≠æÁöÑ PRÔºàÈÅøÂÖç fork Ê≥®ÂÖ•È£éÈô©Ôºâ
    if: |
      github.event.pull_request.head.repo.full_name == github.repository &&
      contains(github.event.pull_request.labels.*.name, 'auto-pr')

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Install Codex CLI
        run: npm install -g @openai/codex

      - name: Download PR diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_API_URL: ${{ github.event.pull_request.url }}
        run: |
          # Áî® GitHub API Áõ¥Êé•Êãø diffÔºåÈÅøÂÖç checkout Ê∑±Â∫¶/merge-base Âùë
          curl -fsSL \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3.diff" \
            "$PR_API_URL" > /tmp/pr.diff
          wc -l /tmp/pr.diff

      - name: Run Codex Review (structured JSON)
        id: codex
        env:
          CUSTOM_OPENAI_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -euo pipefail

          cat > /tmp/review_schema.json <<'JSON'
          {
            "$schema": "http://json-schema.org/draft-07/schema#",
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "verdict": {"type": "string", "enum": ["APPROVE", "REQUEST_CHANGES"]},
              "summary": {"type": "array", "items": {"type": "string"}},
              "blocking": {"type": "array", "items": {"type": "string"}},
              "suggestions": {"type": "array", "items": {"type": "string"}}
            },
            "required": ["verdict", "summary", "blocking", "suggestions"]
          }
          JSON

          cat > /tmp/review_prompt.txt <<'PROMPT'
          ‰Ω†ÊòØËøô‰∏™ PR ÁöÑ Reviewer„ÄÇ

          Âè™ÂÅö‰ª£Á†ÅÂÆ°Êü•Ôºå‰∏çË¶Å‰øÆÊîπ‰ªª‰ΩïÊñá‰ª∂Ôºå‰∏çË¶ÅËøêË°å‰ªª‰Ωï‰ºöÊîπÂä®‰ªìÂ∫ìÁöÑÂëΩ‰ª§„ÄÇ
          ËØ∑ÈòÖËØª diff Êñá‰ª∂Ôºö/tmp/pr.diffÔºåÁÑ∂ÂêéÁªôÂá∫ÁªìÊûÑÂåñÁªìËÆ∫„ÄÇ

          ËßÑÂàôÔºö
          - Â¶ÇÊûúÂ≠òÂú®ÂøÖÈ°ª‰øÆÂ§çÁöÑÈóÆÈ¢òÔºà‰ºöÂØºËá¥ bug„ÄÅÊµãËØïÂ§±Ë¥•„ÄÅÁ†¥ÂùèÂÖºÂÆπ„ÄÅÊòéÊòæ‰∏çÁ¨¶ÂêàÈúÄÊ±ÇÔºâÔºåverdict=REQUEST_CHANGESÔºåÂπ∂ÊääÈóÆÈ¢òÂÜôÂà∞ blocking„ÄÇ
          - Â¶ÇÊûúÊ≤°ÊúâÈòªÂ°ûÈ°πÔºåverdict=APPROVEÔºåblocking ‰∏∫Á©∫Êï∞ÁªÑ„ÄÇ
          - summary Áî® 1-3 Êù°Ê¶ÇÊã¨Êú¨ PR ÂÅö‰∫Ü‰ªÄ‰πà„ÄÇ
          - suggestions ÂèØ‰ª•ÁªôÂèØÈÄâÊîπËøõÔºà‰∏çÂº∫Âà∂Ôºâ„ÄÇ
          PROMPT

          # Áî® codex exec + output schema Âº∫Âà∂‰∫ßÂá∫Êú∫Âô®ÂèØËß£ÊûêÁªìÊûú
          codex \
            -c 'model_providers.custom_openai.name="Custom OpenAI"' \
            -c 'model_providers.custom_openai.base_url="${{ secrets.OPENAI_BASE_URL }}"' \
            -c 'model_providers.custom_openai.env_key="CUSTOM_OPENAI_KEY"' \
            -c 'model_provider="custom_openai"' \
            -a on-failure \
            exec \
            --sandbox read-only \
            --output-schema /tmp/review_schema.json \
            --output-last-message /tmp/review_out.json \
            -m gpt-5.3-codex \
            - < /tmp/review_prompt.txt

          python3 - <<'PY'
          import json
          from pathlib import Path

          data = json.loads(Path('/tmp/review_out.json').read_text('utf-8'))
          verdict = data['verdict']

          md = []
          md.append(f"VERDICT: {verdict}")
          md.append("")
          md.append("Summary:")
          for x in data['summary']:
            md.append(f"- {x}")
          md.append("")
          md.append("Blocking:")
          if data['blocking']:
            for x in data['blocking']:
              md.append(f"- {x}")
          else:
            md.append("- None")
          md.append("")
          md.append("Suggestions:")
          if data['suggestions']:
            for x in data['suggestions']:
              md.append(f"- {x}")
          else:
            md.append("- None")

          Path('/tmp/review.md').write_text("\n".join(md), encoding='utf-8')
          print(verdict)
          PY

          VERDICT=$(python3 -c 'import json; print(json.load(open("/tmp/review_out.json"))["verdict"])')
          echo "verdict=$VERDICT" >> $GITHUB_OUTPUT

          # ÈÅøÂÖçÂ§öË°å output ÂàÜÈöîÁ¨¶ÂùëÔºöÊää review ÂÜôÂà∞‰∏¥Êó∂Êñá‰ª∂Âπ∂ËæìÂá∫Ë∑ØÂæÑ
          cp /tmp/review.md "$RUNNER_TEMP/review.md"
          echo "review_path=$RUNNER_TEMP/review.md" >> $GITHUB_OUTPUT

      - name: Submit PR review
        uses: actions/github-script@v7
        env:
          REVIEW_PATH: ${{ steps.codex.outputs.review_path }}
          VERDICT: ${{ steps.codex.outputs.verdict }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const pr = context.payload.pull_request;
            const verdict = (process.env.VERDICT || '').trim().toUpperCase();
            const reviewPath = process.env.REVIEW_PATH;
            const body = reviewPath && fs.existsSync(reviewPath)
              ? fs.readFileSync(reviewPath, 'utf8')
              : '(no review text)';

            const event = verdict === 'APPROVE' ? 'APPROVE' : 'REQUEST_CHANGES';

            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              event,
              body,
            });

      - name: Send feedback back to Issue (max 5 rounds)
        if: ${{ steps.codex.outputs.verdict == 'REQUEST_CHANGES' }}
        uses: actions/github-script@v7
        env:
          REVIEW_PATH: ${{ steps.codex.outputs.review_path }}
        with:
          # Áî® PAT Ëß¶Âèë issues:labeled Â∑•‰ΩúÊµÅÔºåÈÅøÂÖç GitHub Èò≤ÈÄíÂΩíÊú∫Âà∂Âêû‰∫ã‰ª∂
          github-token: ${{ secrets.PAT }}
          script: |
            const fs = require('fs');
            const pr = context.payload.pull_request;
            const body = (pr.body || '');
            const m = body.match(/Closes\s+#(\d+)/i);
            if (!m) {
              core.warning('PR body has no Closes #<issue>, skip sending feedback');
              return;
            }
            const issue_number = Number(m[1]);

            const marker = '<!-- AI_PR_REVIEW_FEEDBACK -->';
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              per_page: 100,
            });
            const rounds = comments.filter(c => (c.body || '').includes(marker)).length;
            const nextRound = rounds + 1;

            if (nextRound > 5) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number,
                body: `${marker}\n‚ö†Ô∏è PR Reviewer: Â∑≤ËææÂà∞ÊúÄÂ§ßÂõûÂêàÊï∞ 5ÔºåÂÅúÊ≠¢Ëá™Âä®ÂæÄËøî„ÄÇ\nËØ∑‰∏ª‰∫∫ÊâãÂä®‰ªãÂÖ•Ôºö${pr.html_url}`
              });
              return;
            }

            const reviewPath = process.env.REVIEW_PATH;
            const reviewText = reviewPath && fs.existsSync(reviewPath)
              ? fs.readFileSync(reviewPath, 'utf8')
              : '(no review text)';

            const commentBody = [
              marker,
              `### üîÅ PR Reviewer ÂèçÈ¶àÔºàÁ¨¨ ${nextRound}/5 ËΩÆÔºâ`,
              `Êù•Ê∫ê PR: #${pr.number} ${pr.html_url}`,
              '',
              reviewText,
              '',
              'ËØ∑ Issue Handler Ê†πÊçÆ‰ª•‰∏ä Blocking/Suggestions ‰øÆÂ§çÂêéÂÜçÊé®Êñ∞Êèê‰∫§„ÄÇ'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              body: commentBody,
            });

            // ÈáçÊñ∞Ëß¶Âèë Issue handlerÔºötoggle auto-work label
            const labels = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              per_page: 100,
            });
            const has = labels.data.some(l => l.name === 'auto-work');
            if (has) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number,
                name: 'auto-work',
              });
            }
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              labels: ['auto-work'],
            });
