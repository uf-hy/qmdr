# PR Reviewer â€” Codex åšå®¡æŸ¥ï¼›æœ‰é—®é¢˜å›ä¼ åˆ° Issue è§¦å‘ä¸‹ä¸€è½®ä¿®å¤ï¼ˆæœ€å¤š 5 è½®ï¼‰
name: PR Reviewer (Codex)

on:
  pull_request_target:
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: pr-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  review:
    runs-on: ubuntu-latest
    # åªå®¡æŸ¥æœ¬ä»“åº“å†…åˆ†æ”¯ + ä¸”å¸¦ auto-pr æ ‡ç­¾çš„ PRï¼ˆé¿å… fork æ³¨å…¥é£é™©ï¼‰
    if: |
      github.event.pull_request.head.repo.full_name == github.repository &&
      contains(github.event.pull_request.labels.*.name, 'auto-pr')

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Install Codex CLI
        run: npm install -g @openai/codex

      - name: Fetch base
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1 || true

      - name: Run Codex Review
        id: codex
        env:
          CUSTOM_OPENAI_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -euo pipefail
          BASE="${{ github.event.pull_request.base.ref }}"

          cat > /tmp/review_prompt.txt <<'PROMPT'
          ä½ æ˜¯è¿™ä¸ª PR çš„ Reviewerã€‚

          è¦æ±‚ï¼š
          1) åªåšä»£ç å®¡æŸ¥ï¼Œä¸è¦ä¿®æ”¹ä»»ä½•æ–‡ä»¶ã€‚
          2) ä¸è¦å»ºè®®æ— å…³é‡æ„ï¼›åªæŒ‡å‡ºä¸æœ¬ PR ç›¸å…³çš„é£é™©/é—®é¢˜/æ”¹è¿›ã€‚
          3) è¾“å‡ºå¿…é¡»ä¸¥æ ¼æŒ‰ä»¥ä¸‹æ ¼å¼ï¼š
             - ç¬¬ä¸€è¡Œï¼šVERDICT: APPROVE æˆ– VERDICT: REQUEST_CHANGES
             - ç„¶åä¾æ¬¡è¾“å‡ºï¼š
               Summary:
               - ...
               Blocking:
               - ...ï¼ˆå¦‚æœæ²¡æœ‰é˜»å¡é¡¹å†™ Noneï¼‰
               Suggestions:
               - ...ï¼ˆå¯ä¸ºç©ºï¼‰
          4) å¦‚æœéœ€è¦ Issue ä¾§ç»§ç»­ä¿®å¤ï¼Œè¯·åœ¨ Blocking é‡Œå†™æ¸…æ¥šã€Œè¦æ”¹å“ªé‡Œ / ä¸ºä»€ä¹ˆ / å¦‚ä½•éªŒæ”¶ã€ã€‚
          PROMPT

          codex \
            -c 'model_providers.custom_openai.name="Custom OpenAI"' \
            -c 'model_providers.custom_openai.base_url="${{ secrets.OPENAI_BASE_URL }}"' \
            -c 'model_providers.custom_openai.env_key="CUSTOM_OPENAI_KEY"' \
            -c 'model_provider="custom_openai"' \
            review --base "$BASE" - < /tmp/review_prompt.txt | tee /tmp/review.txt

          echo "text<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/review.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          VERDICT=$(head -n 1 /tmp/review.txt | sed -E 's/^VERDICT:[[:space:]]*//')
          echo "verdict=$VERDICT" >> $GITHUB_OUTPUT

      - name: Submit PR review
        uses: actions/github-script@v7
        env:
          REVIEW_TEXT: ${{ steps.codex.outputs.text }}
          VERDICT: ${{ steps.codex.outputs.verdict }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const verdict = (process.env.VERDICT || '').trim().toUpperCase();
            const body = process.env.REVIEW_TEXT || '(no review text)';

            const event = verdict.includes('APPROVE') ? 'APPROVE' : 'REQUEST_CHANGES';

            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              event,
              body,
            });

      - name: Send feedback back to Issue (max 5 rounds)
        if: ${{ !contains(steps.codex.outputs.verdict, 'APPROVE') }}
        uses: actions/github-script@v7
        env:
          REVIEW_TEXT: ${{ steps.codex.outputs.text }}
        with:
          # ç”¨ PATï¼ˆé GITHUB_TOKENï¼‰è§¦å‘ issues:labeled å·¥ä½œæµï¼Œé¿å… GitHub é˜²é€’å½’æœºåˆ¶åäº‹ä»¶
          github-token: ${{ secrets.PAT }}
          script: |
            const pr = context.payload.pull_request;
            const body = (pr.body || '');
            const m = body.match(/Closes\s+#(\d+)/i);
            if (!m) {
              core.warning('PR body has no Closes #<issue>, skip sending feedback');
              return;
            }
            const issue_number = Number(m[1]);

            // ç»Ÿè®¡è½®æ¬¡ï¼ˆæœ€å¤š 5 è½®ï¼‰
            const marker = '<!-- AI_PR_REVIEW_FEEDBACK -->';
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              per_page: 100,
            });
            const rounds = comments.filter(c => (c.body || '').includes(marker)).length;
            const nextRound = rounds + 1;

            if (nextRound > 5) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number,
                body: `${marker}\nâš ï¸ PR Reviewer: å·²è¾¾åˆ°æœ€å¤§å›åˆæ•° 5ï¼Œåœæ­¢è‡ªåŠ¨å¾€è¿”ã€‚\nè¯·ä¸»äººæ‰‹åŠ¨ä»‹å…¥ï¼š${pr.html_url}`
              });
              return;
            }

            const reviewText = process.env.REVIEW_TEXT || '(no review text)';
            const commentBody = [
              marker,
              `### ğŸ” PR Reviewer åé¦ˆï¼ˆç¬¬ ${nextRound}/5 è½®ï¼‰`,
              `æ¥æº PR: #${pr.number} ${pr.html_url}`,
              '',
              reviewText,
              '',
              'è¯· Issue Handler æ ¹æ®ä»¥ä¸Š Blocking/Suggestions ä¿®å¤åå†æ¨æ–°æäº¤ã€‚'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              body: commentBody,
            });

            // é‡æ–°è§¦å‘ Issue handlerï¼štoggle auto-work label
            const labels = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              per_page: 100,
            });
            const has = labels.data.some(l => l.name === 'auto-work');
            if (has) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number,
                name: 'auto-work',
              });
            }
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              labels: ['auto-work'],
            });
