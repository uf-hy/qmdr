name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  id-token: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  verify-version:
    name: Verify tag/version consistency
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.ver.outputs.tag }}
      version: ${{ steps.ver.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.6

      - id: ver
        name: Compare git tag and package version
        shell: bash
        run: |
          set -euo pipefail
          tag="${GITHUB_REF_NAME#v}"
          version="$(bun -e 'const pkg = await Bun.file("package.json").json(); console.log(pkg.version)')"

          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "version=$version" >> "$GITHUB_OUTPUT"

          if [ "$tag" != "$version" ]; then
            echo "Tag version (v$tag) does not match package.json version ($version)"
            exit 1
          fi

          echo "Version check passed: v$tag"

  build:
    name: Build binaries
    needs: verify-version
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            target: darwin-arm64
            artifact: qmd-darwin-arm64
          - os: macos-latest
            target: darwin-x64
            artifact: qmd-darwin-x64
          - os: ubuntu-latest
            target: linux-x64
            artifact: qmd-linux-x64
          - os: ubuntu-latest
            target: linux-arm64
            artifact: qmd-linux-arm64
          - os: windows-latest
            target: windows-x64
            artifact: qmd-windows-x64

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.6

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build binary
        shell: bash
        run: |
          COMPILE_ARGS="--compile --external node-llama-cpp --external @node-llama-cpp"
          case "${{ matrix.target }}" in
            linux-arm64)
              bun build $COMPILE_ARGS --target=bun-linux-arm64 src/qmd.ts --outfile ${{ matrix.artifact }} ;;
            darwin-x64)
              bun build $COMPILE_ARGS --target=bun-darwin-x64 src/qmd.ts --outfile ${{ matrix.artifact }} ;;
            windows-x64)
              bun build $COMPILE_ARGS --target=bun-windows-x64 src/qmd.ts --outfile ${{ matrix.artifact }}.exe ;;
            *)
              bun build $COMPILE_ARGS src/qmd.ts --outfile ${{ matrix.artifact }} ;;
          esac

      - name: Test binary
        if: matrix.target != 'linux-arm64' && matrix.target != 'darwin-x64'
        shell: bash
        env:
          QMD_SILICONFLOW_API_KEY: ${{ secrets.QMD_SILICONFLOW_API_KEY }}
        run: |
          if [ "${{ matrix.target }}" = "windows-x64" ]; then
            ./${{ matrix.artifact }}.exe --help
          else
            ./${{ matrix.artifact }} --help
          fi
          if [ "${{ matrix.target }}" = "windows-x64" ]; then
            ./${{ matrix.artifact }}.exe doctor 2>&1 || true
          else
            ./${{ matrix.artifact }} doctor 2>&1 || true
          fi
          echo "✅ Binary runs successfully"

      - name: Generate checksum
        shell: bash
        run: |
          set -euo pipefail
          BIN="${{ matrix.artifact }}"
          [ "${{ matrix.target }}" = "windows-x64" ] && BIN="${BIN}.exe"
          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum "$BIN" > "${BIN}.sha256"
          else
            shasum -a 256 "$BIN" > "${BIN}.sha256"
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: |
            ${{ matrix.artifact }}
            ${{ matrix.artifact }}.*

  publish-npm:
    name: Publish npm package
    needs: verify-version
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org

      - name: Validate publish package
        run: npm pack --dry-run

      - name: Publish to npm (trusted publishing preferred)
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          if [ -n "${NODE_AUTH_TOKEN:-}" ]; then
            echo "Using NPM_TOKEN auth"
          else
            echo "NPM_TOKEN not set, attempting npm trusted publishing via OIDC"
          fi
          npm publish --access public --provenance || {
            rc=$?
            # Version already exists (409/403) is not a fatal error on re-run
            if npm view qmdr version 2>/dev/null | grep -q "$(node -p 'require("./package.json").version')"; then
              echo "⚠️ Version already published, skipping npm publish"
              exit 0
            fi
            exit $rc
          }

  release:
    name: Create GitHub Release
    needs:
      - build
      - publish-npm
    if: always() && needs.publish-npm.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          merge-multiple: true

      - name: Make binaries executable
        run: chmod +x qmd-* || true

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: qmd-*
          generate_release_notes: true
          draft: false
