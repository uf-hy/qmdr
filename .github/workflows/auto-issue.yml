name: Auto Issue Worker

# Trigger: issue labeled "auto-work", or previous PR merged with "chain-next" label
on:
  issues:
    types: [labeled]
  pull_request:
    types: [closed]

permissions:
  id-token: write
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: auto-issue-${{ github.event.issue.number || github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  # Job 1: When an issue gets "auto-work" label, create branch + PR via OpenCode
  work-on-issue:
    if: |
      github.event_name == 'issues' &&
      github.event.label.name == 'auto-work'
    runs-on: ubuntu-latest
    timeout-minutes: 300
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}

      - name: Configure Git
        run: |
          git config user.name "opencode[bot]"
          git config user.email "opencode[bot]@users.noreply.github.com"

      - name: Create feature branch
        run: |
          BRANCH="auto/issue-${{ github.event.issue.number }}"
          git checkout -b "$BRANCH"
          git push origin "$BRANCH"
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV

      - name: Run OpenCode on issue
        uses: anomalyco/opencode/github@latest
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          GITHUB_TOKEN: ${{ secrets.PAT }}
          QMD_ALLOW_SQLITE_EXTENSIONS: "1"
        with:
          model: custom/gpt-5.2
          use_github_token: true
          prompt: |
            Read issue #${{ github.event.issue.number }} carefully.
            
            RULES:
            1. ONLY modify files listed in the issue's "Scope" section. Do NOT touch other files.
            2. Do NOT add security gates, permission checks, or env-var guards unless explicitly asked.
            3. Focus on: correctness, performance, robustness, clean code.
            4. Run `bun test` after changes to verify nothing breaks.
            5. Keep changes minimal and focused on the issue description.
            6. If the issue mentions "depends on #N", assume that PR is already merged into main.
            
            After making changes, commit with message: "fix: <short description> (closes #${{ github.event.issue.number }})"

      - name: Create PR
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          BRANCH="auto/issue-${{ github.event.issue.number }}"
          
          # Check if there are actual commits
          COMMITS=$(git log origin/main.."$BRANCH" --oneline 2>/dev/null | wc -l)
          if [ "$COMMITS" -eq 0 ]; then
            echo "No commits made, skipping PR creation"
            exit 0
          fi
          
          gh pr create \
            --base main \
            --head "$BRANCH" \
            --title "$(gh issue view ${{ github.event.issue.number }} --json title -q .title)" \
            --body "Closes #${{ github.event.issue.number }}

          Auto-generated by OpenCode from issue #${{ github.event.issue.number }}.
          
          ---
          **Review checklist:**
          - [ ] CI passes
          - [ ] Changes match issue scope
          - [ ] No unrelated modifications" \
            --label "auto-pr"

  # Job 2: When a PR with "auto-pr" merges, trigger the next issue in chain
  chain-next:
    if: |
      github.event_name == 'pull_request' &&
      github.event.pull_request.merged == true &&
      contains(github.event.pull_request.labels.*.name, 'auto-pr')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Find and trigger next issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Extract closed issue number from PR body
          CLOSED_ISSUE=$(echo "${{ github.event.pull_request.body }}" | grep -oP 'Closes #\K\d+' | head -1)
          
          if [ -z "$CLOSED_ISSUE" ]; then
            echo "No linked issue found, skipping chain"
            exit 0
          fi
          
          echo "Merged PR closed issue #$CLOSED_ISSUE"
          
          # Find next issue in the chain by looking for "depends on #N" in open issues
          NEXT_ISSUES=$(gh issue list --state open --label "auto-chain" --json number,body -q ".[] | select(.body | test(\"depends on #$CLOSED_ISSUE\"; \"i\")) | .number")
          
          for ISSUE_NUM in $NEXT_ISSUES; do
            echo "Triggering next issue: #$ISSUE_NUM"
            gh issue edit "$ISSUE_NUM" --add-label "auto-work"
          done
          
          if [ -z "$NEXT_ISSUES" ]; then
            echo "No chained issues found. Pipeline complete!"
          fi
