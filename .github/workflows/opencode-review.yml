name: PR Feedbacker (OpenCode Review) - GPT-5.2 xhigh

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: pr-feedback-${{ github.event.pull_request.number || github.event.issue.number || github.run_id }}
  cancel-in-progress: true

jobs:
  review:
    if: |
      (
        github.event_name == 'pull_request' &&
        github.event.pull_request.draft == false &&
        github.event.pull_request.head.repo.full_name == github.repository
      ) ||
      (
        github.event_name == 'issue_comment' &&
        github.event.issue.pull_request &&
        (contains(github.event.comment.body, '/opencode') || contains(github.event.comment.body, '/oc'))
      )
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Resolve PR context
        id: ctx
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const prNumber = context.eventName === 'pull_request'
              ? context.payload.pull_request.number
              : context.payload.issue.number;

            const { data: pr } = await github.rest.pulls.get({ owner, repo, pull_number: prNumber });

            const body = pr.body || '';
            const m = body.match(/\b(?:Closes|Fixes|Resolves)\s+#(\d+)\b/i);
            const issueNumber = m ? m[1] : '';

            core.setOutput('pr_number', String(prNumber));
            core.setOutput('issue_number', issueNumber);
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('head_sha', pr.head.sha);
            core.setOutput('head_repo', pr.head.repo.full_name);

      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}
          repository: ${{ steps.ctx.outputs.head_repo }}
          ref: ${{ steps.ctx.outputs.head_sha }}

      - name: Run OpenCode (review only)
        uses: anomalyco/opencode/github@latest
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          GITHUB_TOKEN: ${{ secrets.PAT }}
        with:
          model: openai/gpt-5.2
          use_github_token: true
          prompt: |
            <!-- OPENCODE_REVIEW -->
            You are the PR feedbacker. You must ONLY review; you MUST NOT modify any code.

            Hard rules:
            - Do NOT edit files.
            - Do NOT commit.
            - Do NOT push.

            Output format (must be included verbatim):
            <!-- OPENCODE_REVIEW -->
            VERDICT: PASS | NEEDS_CHANGES
            SUMMARY:
            - <plain Chinese summary of what PR changes>
            FINDINGS:
            - <concrete issue 1: file + function/line-range + why + expected change>
            - <issue 2...>
            ACTION_ITEMS:
            - <actionable fix 1>
            - <fix 2...>

            Notes:
            - Model MUST be openai/gpt-5.2.
            - Reasoning effort should follow repo config (.opencode.json = xhigh).

      - name: Post review result (PR review + issue feedback)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = Number('${{ steps.ctx.outputs.pr_number }}');
            const issueNumber = Number('${{ steps.ctx.outputs.issue_number }}' || '0');

            // Fetch latest PR comments and find the latest OPENCODE_REVIEW block
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number: prNumber,
              per_page: 100,
            });

            const marker = '<!-- OPENCODE_REVIEW -->';
            const reviewComment = comments
              .slice()
              .reverse()
              .find(c => (c.body || '').includes(marker));

            if (!reviewComment) {
              core.setFailed('No OPENCODE_REVIEW comment found on PR.');
              return;
            }

            const body = reviewComment.body || '';
            const verdictMatch = body.match(/VERDICT:\s*(PASS|NEEDS_CHANGES)/i);
            const verdict = verdictMatch ? verdictMatch[1].toUpperCase() : 'NEEDS_CHANGES';

            // Submit a formal GitHub Review to satisfy branch protection (1 approval required)
            const event = verdict === 'PASS' ? 'APPROVE' : 'REQUEST_CHANGES';
            await github.rest.pulls.createReview({
              owner,
              repo,
              pull_number: prNumber,
              event,
              body: `Automated AI review result (OpenCode):\n\n${body}`,
            });

            // If linked issue exists and NEEDS_CHANGES, post feedback to the issue to trigger the issue handler.
            if (issueNumber && verdict === 'NEEDS_CHANGES') {
              const issueComments = await github.paginate(github.rest.issues.listComments, {
                owner,
                repo,
                issue_number: issueNumber,
                per_page: 100,
              });
              const rounds = issueComments.filter(c => (c.body || '').includes('#AI_PR_REVIEW_FEEDBACK')).length;
              const nextRound = rounds + 1;

              if (nextRound > 5) {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: issueNumber,
                  body: `#AI_PR_REVIEW_FEEDBACK\nROUND: ${nextRound}/5\nPR: ${prNumber}\nVERDICT: NEEDS_CHANGES\n\nSTOP: reached max 5 rounds. Please fix manually.\n\n---\n${body}`,
                });
                return;
              }

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issueNumber,
                body: `#AI_PR_REVIEW_FEEDBACK\nROUND: ${nextRound}/5\nPR: ${prNumber}\nBRANCH: ${{ steps.ctx.outputs.head_ref }}\nHEAD_SHA: ${{ steps.ctx.outputs.head_sha }}\nVERDICT: NEEDS_CHANGES\n\n---\n${body}`,
              });
            }
