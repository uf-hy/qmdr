name: OpenCode PR Review (GPT-5.2 xhigh)

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write
  id-token: write

concurrency:
  group: opencode-review-${{ github.event.pull_request.number || github.event.issue.number || github.run_id }}
  cancel-in-progress: true

jobs:
  review:
    if: |
      (
        github.event_name == 'pull_request_target' &&
        github.event.pull_request.draft == false &&
        github.event.pull_request.head.repo.full_name == github.repository
      ) ||
      (
        github.event_name == 'issue_comment' &&
        github.event.issue.pull_request &&
        (contains(github.event.comment.body, '/opencode') || contains(github.event.comment.body, '/oc'))
      )
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout PR head
        if: ${{ github.event_name == 'pull_request_target' }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Bun
        if: ${{ github.event_name == 'pull_request_target' }}
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.6

      - name: OpenCode review (no code changes)
        uses: anomalyco/opencode/github@latest
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          GITHUB_TOKEN: ${{ secrets.PAT }}
        with:
          model: openai/gpt-5.2
          use_github_token: true
          prompt: |
            You are a strict PR reviewer.

            IMPORTANT RULE:
            - Do NOT modify any files.
            - Do NOT commit or push.
            - Only review and leave feedback.

            What to do:
            1) Read the PR diff and explain what it changes in plain Chinese.
            2) List concrete problems (bugs, edge cases, security, maintainability).
            3) For each problem: point to file+function (or line range) and explain why.
            4) End with a clear verdict:
               - VERDICT: PASS  (safe to merge)
               - or VERDICT: NEEDS_CHANGES (must fix before merge)

            Notes:
            - Model must be openai/gpt-5.2.
            - Reasoning effort should follow repository config (.opencode.json sets xhigh).
